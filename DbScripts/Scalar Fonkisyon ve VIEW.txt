USE BusReservationDB
GO

-- 1. SCALAR FUNCTION (Toplam Ciro)
CREATE OR ALTER FUNCTION fn_GetTotalRevenue()
RETURNS DECIMAL(18,2)
AS
BEGIN
    DECLARE @Total DECIMAL(18,2);
    
    SELECT @Total = SUM(TotalAmount) 
    FROM Bookings 
    WHERE BookingStatus = 'Confirmed';

    RETURN ISNULL(@Total, 0);
END
GO

-- 2. VIEW (Ä°statistikler)
CREATE OR ALTER VIEW v_DashboardStats
AS
    SELECT 
        (SELECT COUNT(*) FROM Tickets) AS TotalTickets,
        (SELECT COUNT(*) FROM Schedules WHERE DepartureTime > GETDATE()) AS ActiveSchedules,
        (SELECT COUNT(*) FROM ContactMessages WHERE IsRead = 0) AS UnreadMessages
GO