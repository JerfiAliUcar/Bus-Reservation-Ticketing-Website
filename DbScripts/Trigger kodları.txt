USE BusReservationDB
GO

-- 1. LOG TABLOSUNU OLUŞTUR (Eğer yoksa)
-- İptal edilen biletlerin "Kim, Ne Zaman, Hangi Bilet" bilgisini burada tutacağız.
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'TicketAuditLogs')
BEGIN
    CREATE TABLE TicketAuditLogs (
        LogID INT PRIMARY KEY IDENTITY(1,1),
        TicketID INT,                -- Hangi bilet (Aslında BookingID üzerinden gideceğiz)
        ActionType NVARCHAR(50),     -- 'IPTAL' yazacak
        ActionDate DATETIME DEFAULT GETDATE(), -- Ne zaman?
        OldPassengerName NVARCHAR(250) -- Ekstra bilgi (PNR vb.)
    );
END
GO

-- 2. TRIGGER'I OLUŞTUR (Veya varsa güncelle)
CREATE OR ALTER TRIGGER trg_BookingCancellationAudit
ON Bookings
AFTER UPDATE
AS
BEGIN
  
    SET NOCOUNT ON;

    
    IF UPDATE(BookingStatus)
    BEGIN
        -- Mantık: 'Confirmed' durumundan 'Cancelled' durumuna geçen kayıtları yakala.
        -- 'inserted' tablosu yeni hali, 'deleted' tablosu eski hali tutar.
        
        INSERT INTO TicketAuditLogs (TicketID, ActionType, ActionDate, OldPassengerName)
        SELECT 
            t.TicketId, 
            'IPTAL', 
            GETDATE(), 
            'PNR: ' + i.PNR + ' - İptal Edilen İşlem' 
        FROM inserted i
        JOIN deleted d ON i.BookingId = d.BookingId
        JOIN Tickets t ON i.BookingId = t.BookingId -- O rezervasyona ait biletleri buluyoruz
        WHERE i.BookingStatus = 'Cancelled' AND d.BookingStatus != 'Cancelled';
    END
END
GO